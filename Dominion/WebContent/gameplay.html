<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Index</title>
<link rel="stylesheet" type="text/css" href="css/default.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.css">
<script>
	$(".detailView").fancybox({
		openEffect	: 'elastic',
		closeEffect	: 'elastic',
	
		helpers : {
			title : {
				type : 'inside'
			}
		}
	});

	$(window).ready(function() {
		var players;
		
	    /**** GET PLAYERS ****/
	    function getPlayers() {
		    $.ajax({
				type: 'POST',
				data: {operation: "getPlayers"},
				url: 'AjaxController',
				success: function(result){
					$(".players").html(result);
				}
			});
	    }
	    
	    /**** GET VICTORY CARDS ****/
	    function getVictoryCards() {
		    $.ajax({
				type: 'POST',
				data: {operation: "getVictoryCards"},
				url: 'AjaxController',
				success: function(result){
					$(".victoryCards").html(result);
					resizeCards();
				}
			});
	    }
	    
	    /**** GET TREASURE CARDS ****/
	    function getTreasureCards() {
		    $.ajax({
				type: 'POST',
				data: {operation: "getTreasureCards"},
				url: 'AjaxController',
				success: function(result){
					$(".treasureCards").html(result);
					resizeCards();
				}
			});
	    }
	    
	    /**** GET CURSE CARDS ****/
	    function getCurseCards() {
		    $.ajax({
				type: 'POST',
				data: {operation: "getCurseCards"},
				url: 'AjaxController',
				success: function(result){
					$(".curseCards").html(result);
					resizeCards();
				}
			});
	    }
	    
	    /**** GET KINGDOM CARDS ****/
	    function getKingdomCards() {
		    $.ajax({
				type: 'POST',
				data: {operation: "getKingdomCards"},
				url: 'AjaxController',
				success: function(result){
					$(".kingdomCards").html(result);
					resizeCards();
				}
			});
	    }
	    
	    /**** GET PLAYER ON TURN ****/
	    function getPlayerOnTurn() {
		    $.ajax({
				type: 'POST',
				data: {operation: "getPlayerOnTurn"},
				url: 'AjaxController',
				success: function(result){
					$(".player").removeClass("onTurn");
					$(".player .piles").removeClass("hidden");
					
					$("div[name=" + result + "]").addClass("onTurn");
					$(".player .piles:not(div[name=" + result + "] .piles)").addClass("hidden");
				}
			});
	    }
	    
		/**** DRAW ****/
	    function draw() {
	    	$.ajax({
				type: 'POST',
				data: {operation: "draw"},
				url: 'AjaxController',
				success: function(result){
					$(".handCards").html(result);
					resizeCards();
					rotateCards();
				}
			});
	    }
		
		/**** CLEARS ****/
		function clearPlayedCards() {
			$(".playedCards").html("<div class='overviewTurn'><h4>Actions</h4><div class='amountActions'>1</div><h4>Buys</h4><div class='amountBuys'>1</div><h4>Coins</h4><div class='amountCoins'>0</div></div><div class='actionButtons'><button type='button' class='' id='endActionPhase'>End action phase</button></div>");
		}
		
		function clearBuyableCards() {
			$(".kingdomCards .buy").addClass("hidden");
		}
	    
	    /*$.ajax({
			type: 'POST',
			data: {operation: "getTrash"},
			url: 'AjaxController',
			success: function(result){
				$(".trashPile").html(result);
				resizeCards();
			}
		});*/
		
		/*window.onbeforeunload = function() {
	        return "";
	    }*/
	    
	    getPlayers();
	    getVictoryCards();
	    getTreasureCards();
	    getCurseCards();
	    getKingdomCards();
	    getPlayerOnTurn();
	    draw();
	    
	    $(".handCards").on("click", ".inHand", function() {
	    	play(this);
	    });
	    
	    /*$(".actionButtons").on("click", "#playAllTreasureCards", function() {
	    	var numberCardsInHand = $(".inHand").length;
	    	for (i = 0; i < numberCardsInHand; i++) {
	    		var card = $(".inHand[numberinhand='" + i + "']");
	    		var cardtype = $(card).attr("cardtype");
	    		
	    		if(cardtype == "Treasure") {
	    			play(card);
	    		}
	    	}
	    });*/
	    
	    $(".actionButtons").on("click", "#endActionPhase", function() {
	    	$.ajax({
				type: 'POST',
				data: {operation: "endPhase"},
				url: 'AjaxController',
				success: function(result){
					$(".actionButtons").html(result);
				}
			});
	    });
	    
	    $(".actionButtons").on("click", "#endTreasurePhase", function() {
	    	$.ajax({
				type: 'POST',
				data: {operation: "endPhase"},
				url: 'AjaxController',
				success: function(result){
					$(".actionButtons").html(result);
				}
			});
	    });
	    
	    $(".actionButtons").on("click", "#endTurn", function() {
	    	$.ajax({
				type: 'POST',
				data: {operation: "endTurn"},
				url: 'AjaxController',
				success: function(result){
					$(".actionButtons").html(result);
				}
			});
	    	
	    	getPlayerOnTurn();
	    	draw();
	    	clearPlayedCards();
	    	disableBuyableCards();
	    });
	    
	    function play(card) {
	    	var cardtype = $(card).attr("cardtype");
	    	
	    	$.ajax({
				type: 'POST',
				data: {operation: "getPhase"},
				url: 'AjaxController',
				success: function(result){
					var phase = result;
					console.log("Phase: " + phase);
					
					if(phase == 1 && cardtype == "Action" || cardtype == "Action - Attack") {
						console.log("Action( - Attack)!");
						playThisCard(card);
					}
						
					else if(phase == 2 && cardtype == "Treasure") {
						console.log("Treasure!");
					    playThisCard(card);
				    }
					
					function playThisCard() {
						var cardname = $(card).attr("cardname");
				    	var numberinhand = $(card).attr("numberinhand");
					    
					    $(card).appendTo(".playedCards");
					    $(card).removeClass("inHand");
					    $(card).addClass("played");
					    
					    //resizeCards();
					    //rotateCards();
						
						$.ajax({
							type: 'POST',
							data: {operation: "play",
								cardname: cardname,
								numberinhand: numberinhand},
							url: 'AjaxController',
							success: function(result){
								$("#result2").html(result);
								updateStats();
							}
						});
						
						draw();
					}
				}
			});
	    }
	    
		function updateStats() {
	    	$.ajax({
				type: 'POST',
				data: {operation: "updateStats"},
				url: 'AjaxController',
				success: function(result){
					$(".overviewTurn").html(result);
				}
			});
	    	
	    	$.ajax({
				type: 'POST',
				data: {operation: "getBuys"},
				url: 'AjaxController',
				success: function(result){
			    	if(result >= 1) {
				    	$.ajax({
							type: 'POST',
							data: {operation: "getCoins"},
							url: 'AjaxController',
							success: function(result){
						    	enableBuyableCards(result);
							}
						});
			    	}
			    	
			    	else {
			    		disableBuyableCards();
			    	}
				}
			});
	    }
		
	    $("body").on("click", ".card button", function() {
	    	var numberindiv = $(this).attr("numberindiv");
	    	
	    	$.ajax({
				type: 'POST',
				data: {operation: "buyCard",
					numberindiv: numberindiv},
				url: 'AjaxController'
			});
	    	
	    	updateStats();
	    });
		
		function enableBuyableCards(amountCoins) {
			console.log("Amount coins: " + amountCoins);
			for (i = 0; i < 3; i++) {
				var cost = $(".treasureCards .card[numberindiv=" + i + "]").attr("cost");
				
				if(amountCoins >= cost) {
					$(".treasureCards .card[numberindiv=" + i + "] .buy").removeClass("hidden");
				}
			}
			
			for (i = 3; i < 6; i++) {
				var cost = $(".victoryCards .card[numberindiv=" + i + "]").attr("cost");
				
				if(amountCoins >= cost) {
					$(".victoryCards .card[numberindiv=" + i + "] .buy").removeClass("hidden");
				}
			}
			
			for (i = 6; i < 7; i++) {
				var cost = $(".curseCards .card[numberindiv=" + i + "]").attr("cost");
				
				if(amountCoins >= cost) {
					$(".curseCards .card[numberindiv=" + i + "] .buy").removeClass("hidden");
				}
			}
			
			for (i = 7; i < 17; i++) {
				var cost = $(".kingdomCards .card[numberindiv=" + i + "]").attr("cost");
				
				if(amountCoins >= cost) {
					$(".kingdomCards .card[numberindiv=" + i + "] .buy").removeClass("hidden");
				}
			}
		}
		
		function disableBuyableCards() {
			for (i = 0; i < 3; i++) {
					$(".treasureCards .card[numberindiv=" + i + "] .buy").addClass("hidden");
			}
			
			for (i = 3; i < 6; i++) {
					$(".victoryCards .card[numberindiv=" + i + "] .buy").addClass("hidden");
			}
			
			for (i = 6; i < 7; i++) {
					$(".curseCards .card[numberindiv=" + i + "] .buy").addClass("hidden");
			}
			
			for (i = 7; i < 17; i++) {
					$(".kingdomCards .card[numberindiv=" + i + "] .buy").addClass("hidden");
			}
		}
	});
	
	$(window).resize(function() {
		resizeCards();
		rotateCards();
	});
	
	function resizeCards() {
		var heightVictoryCards = $(".victoryCards .card").height();
		var heightKingdomCards = $(".kingdomCards .card").height();
		var heightTreasureCards = $(".treasureCards .card").height();
		var heightHandCards = $(".handCards .card").height();
		var heightPlayedCards = $(".playedCards .card").height();
		var widthDiscardPileCards = $(".discardPile").width();
		
		var widthVictoryCards = heightVictoryCards * 1.217;
		var widthKingdomCards = heightKingdomCards * 1.217;
		var widthTreasureCards = heightTreasureCards * 1.217;
		var widthHandCards = heightHandCards * 0.652;
		var widthPlayedCards = heightPlayedCards * 0.652;
		var heightDiscardPileCards = widthDiscardPileCards * 1.533;
		
		$(".victoryCards .card, .treasureCards .card, .curseCards .card").css("width", widthVictoryCards);
		$(".kingdomCards .card").css("width", widthKingdomCards);
		$(".handCards .card").css("width", widthHandCards);
		$(".playedCards .card").css("width", widthPlayedCards);
		$(".discardPile, .cardPile").css("height", heightDiscardPileCards);
	}
	
	function rotateCards() {
		var numberHandCards = $(".handCards .card").length;
		
		if(numberHandCards >= 5) {
			var rotate = -15;
			var rotateInterval = 30 / (numberHandCards - 1);
		}
		
		else {
			if(numberHandCards == 1) {
				var rotate = 0;
			}
			
			else {
				var rotate = numberHandCards * -3;
				var rotateFullAngle = numberHandCards * 3 * 2;
				var rotateInterval = rotateFullAngle / (numberHandCards - 1);
			}
		}
		
		var handCards = document.getElementsByClassName("inHand");
		
		for (i = 0; i < numberHandCards; i++) {		
			handCards[i].style.transform = "rotate(" + rotate + "deg)"; 
			
			rotate += rotateInterval;
		}
		
		if (numberHandCards > 9) {
			var marginLeftHandCards = -100 - (numberHandCards * 5 / 2); 
			$(".handCards .card").css("margin-left", marginLeftHandCards);
			$(".handCards .card:first-child").css("margin-left", "0");
		}
	}
</script>
</head>
<body>
	<div class="left">
		<div class="cards victoryCards"></div>
	</div>
	<div class="left bottom" id="playersContainer">
		<div class="players"></div>
	</div>
	<div class="right">
		<div class="cards treasureCards"></div>
	</div>
	<div class="right bis">
		<div class="cards curseCards"></div>
	</div>
	<div class="right bottom" id="optionsContainer">
		<div class="options">
			<div class="halfHorizontal">
				<button type="button" class="" id="fullscreen">F</button>
				<button type="button" class="">O</button>
				<button type="button" class="">R</button>
			</div>
			<div class="halfHorizontal">
				<div class="piles">
					<div class="trashPile"></div>
				</div>
				<span id="result2"></span>
				<span id="result3"></span>
			</div>
		</div>
	</div>
	<div class="center">
		<div class="cards kingdomCards"></div>
		<div class="cards playedCards">
			<div class="overviewTurn">
				<h4>Actions</h4>
				<div class="amountActions">1</div>
				<h4>Buys</h4>
				<div class="amountBuys">1</div>
				<h4>Coins</h4>
				<div class="amountCoins">0</div>
			</div>
			<div class="actionButtons">
				<button type="button" class="" id="endActionPhase">End action phase</button>
			</div>
		</div>
		<div class="cards handCards"></div>
	</div>
</body>
</html>